stages:
  - test
  - doc
  - reqt
  - lint

job0:
  stage: .pre
  tags:
    - python
    - linux
    - mysql
  script:
    - export NEPC_HOME=$CI_PROJECT_DIR
    - conda env remove --name nepc
    - conda env create -f environment.yml
    - conda activate nepc
    - pip install pylint-exit
    - pip install anybadge
    - pip install docstr-coverage
    - conda install pylint
    - pip install -e .

pytest:
  stage: test
  tags:
    - linux
    - mysql
    - python
  script:
    - export NEPC_HOME=$CI_PROJECT_DIR
    - conda activate nepc
    - pytest --cov=nepc tests/ | tee pytest.txt
    - score=$(cat pytest.txt | grep TOTAL | grep -o -P '[0-9]*(\.[0-9]*)?(?=%)')
    - echo "test coverage is ${score}%"
    - anybadge --label=pytest --value=$score --suffix='%' --file=pytest.svg 50=red 60=orange 80=yellow 100=green
  artifacts:
    paths:
        - pytest.svg
    when: always
    expire_in: 6 months
    

sphinx:
  stage: doc
  tags:
    - linux
    - python
  script:
    - export NEPC_HOME=$CI_PROJECT_DIR
    - conda activate nepc
    - cd $NEPC_HOME/doc
    - make html
    - rsync -rl _build/html/ /srv/shiny-server/nepc/doc/ --delete
    - cd $NEPC_HOME
    - docstr-coverage nepc | tee docstr.txt || true
    - score=$(cat docstr.txt | tail -n 1 | grep -Eo '[+-]?[0-9]+([.][0-9]+)?')
    - echo "docstr-coverage score was ${score}%"
    - anybadge --label=doc --value=$score --suffix='%' --file=sphinx.svg 50=red 60=orange 80=yellow 100=green
  artifacts:
    paths:
        - sphinx.svg
    when: always
    expire_in: 6 months

doorstop:
  stage: reqt
  tags:
    - linux
    - python
  script:
    - export NEPC_HOME=$CI_PROJECT_DIR
    - conda activate nepc
    - doorstop >& doorstop.txt
    - cat doorstop.txt
    - warnings=$(cat doorstop.txt | grep WARNING | wc -l)
    - echo "doorstop had $warnings warnings"
    - anybadge --label=reqt --value=$warnings --suffix=' warnings' --file=doorstop.svg 1=green 100=yellow
    - doorstop publish all /srv/shiny-server/nepc/reqt
  artifacts:
    paths:
        - doorstop.svg
    when: always
    expire_in: 6 months

pylint:
  stage: lint
  tags:
    - linux
    - python
  script:
    - export NEPC_HOME=$CI_PROJECT_DIR
    - conda activate nepc
    - pylint --output-format=text nepc/ | tee pylint.txt || pylint-exit $?
    - score=$(sed -n 's/^Your code has been rated at \([-0-9.]*\)\/.*/\1/p' pylint.txt)
    - echo "Pylint score was $score"
    - anybadge --value=$score --file=pylint.svg pylint
  artifacts:
    paths:
        - pylint.svg
    when: always
    expire_in: 6 months

